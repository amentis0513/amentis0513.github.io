<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Google SSO â€” Redirect to letter.html</title>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          "Helvetica Neue",
          Arial;
        padding: 2rem;
      }
      .container {
        max-width: 520px;
        margin: 0 auto;
      }
      #message {
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Sign in with Google</h1>
      <div id="gbutton"></div>
      <p id="message">Not signed in.</p>
    </div>

    <script>
      const CLIENT_ID =
        "723291403650-e1a0p205fdthllg4kngnteo9dtupgc6e.apps.googleusercontent.com";

      // Optional: decode JWT payload client-side (used here only for display)
      function decodeJwtPayload(token) {
        try {
          const parts = token.split(".");
          if (parts.length !== 3) return null;
          const payload = parts[1].replace(/-/g, "+").replace(/_/g, "/");
          const padded = payload.padEnd(
            payload.length + ((4 - (payload.length % 4)) % 4),
            "=",
          );
          return JSON.parse(atob(padded));
        } catch (e) {
          return null;
        }
      }

      function handleGisLoad() {
        google.accounts.id.initialize({
          client_id: CLIENT_ID,
          callback: handleCredentialResponse,
        });

        google.accounts.id.renderButton(document.getElementById("gbutton"), {
          theme: "outline",
          size: "large",
        });
      }

      function handleCredentialResponse(response) {
        if (!response || !response.credential) {
          document.getElementById("message").textContent =
            "Sign-in failed: no credential returned.";
          return;
        }

        // Save ID token in sessionStorage so letter.html can use it if needed
        sessionStorage.setItem("google_id_token", response.credential);

        // Optional: show immediate feedback, then redirect
        const payload = decodeJwtPayload(response.credential);
        const display = payload?.email || payload?.name || "signed in";
        document.getElementById("message").textContent =
          "Signed in as: " + display;

        // Redirect to letter.html
        // Small delay (200ms) so message is visible briefly; remove delay if not needed
        setTimeout(() => {
          window.location.href = "letter.html";
        }, 200);
      }

      (function waitForGis() {
        if (window.google && google.accounts && google.accounts.id) {
          handleGisLoad();
        } else {
          setTimeout(waitForGis, 50);
        }
      })();
    </script>
  </body>
</html>
